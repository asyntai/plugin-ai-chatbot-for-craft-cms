{% extends "_layouts/cp" %}
{% set title = 'Asyntai AI Chatbot' %}

{% set siteId = settings.siteId ?? '' %}
{% set accountEmail = settings.accountEmail ?? '' %}
{% set scriptUrl = settings.scriptUrl ?? 'https://asyntai.com/static/js/chat-widget.js' %}
{% set connected = siteId|length %}

{% block content %}
<div id="asyntai-settings-wrap">

    <p id="asyntai-status">
        Status: <span style="color:{{ connected ? '#008a20' : '#a00' }};">{{ connected ? 'Connected' : 'Not connected' }}</span>{% if connected and accountEmail %} as {{ accountEmail }}{% endif %}
        {% if connected %}
            <button id="asyntai-reset" class="btn">Reset</button>
        {% endif %}
    </p>

    <div id="asyntai-alert" class="callout" style="display:none;margin:10px 0;"></div>

    <div id="asyntai-connected-box" style="display:{{ connected ? 'block' : 'none' }};">
        <div style="max-width:820px;margin:20px auto;padding:20px;border:1px solid #ddd;border-radius:8px;background:#fff;text-align:center;">
            <div style="font-size:20px;font-weight:700;margin-bottom:8px;">Asyntai is now enabled</div>
            <div style="font-size:16px;margin-bottom:16px;">Set up your AI chatbot, review chat logs and more:</div>
            <a class="btn" style="background-color:#2563eb;color:#fff;border-color:#2563eb;" href="https://asyntai.com/dashboard" target="_blank" rel="noopener">Open Asyntai Panel</a>
            <div style="margin-top:16px;font-size:14px;color:#666;">
                <strong>Tip:</strong> If you want to change how the AI answers, please <a href="https://asyntai.com/dashboard#setup" target="_blank" rel="noopener" style="color:#3182ce;text-decoration:underline;">go here</a>.
            </div>
        </div>
    </div>

    <div id="asyntai-popup-wrap" style="display:{{ connected ? 'none' : 'block' }};">
        <div style="max-width:960px;margin:20px auto;padding:24px;border:1px solid #ddd;border-radius:8px;background:#fff;text-align:center;">
            <div style="font-size:18px;margin-bottom:12px;">Create a free Asyntai account or sign in to enable the chatbot</div>
            <button id="asyntai-connect-btn" class="btn" style="background-color:#2563eb;color:#fff;border-color:#2563eb;">Get started</button>
            <div style="margin-top:12px;color:#666;">If it doesn't work, <a href="#" id="asyntai-fallback-link" target="_blank" rel="noopener">open the connect window</a>.</div>
        </div>
    </div>
</div>

<script>
(function(){
    var currentState = null;
    
    function showAlert(msg, ok){
        var el=document.getElementById('asyntai-alert'); if(!el) return;
        el.style.display='block';
        el.className='callout '+(ok?'callout-success':'callout-danger');
        el.textContent=msg;
    }
    
    function generateState(){
        return 'craft_'+Math.random().toString(36).substr(2,9);
    }
    
    function updateFallbackLink(){
        var fallbackLink = document.getElementById('asyntai-fallback-link');
        if(fallbackLink && currentState){
            fallbackLink.href = 'https://asyntai.com/wp-auth?platform=craft&state='+encodeURIComponent(currentState);
        }
    }
    
    function openPopup(){
        currentState = generateState();
        updateFallbackLink();
        var base='https://asyntai.com/wp-auth?platform=craft';
        var url=base+(base.indexOf('?')>-1?'&':'?')+'state='+encodeURIComponent(currentState);
        var w=800,h=720;var y=window.top.outerHeight/2+window.top.screenY-(h/2);var x=window.top.outerWidth/2+window.top.screenX-(w/2);
        var pop=window.open(url,'asyntai_connect','toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width='+w+',height='+h+',top='+y+',left='+x);
        if(!pop){ showAlert('Popup blocked. Please allow popups or use the link below.', false); return; }
        pollForConnection(currentState);
    }
    
    // Initialize fallback link on page load
    currentState = generateState();
    updateFallbackLink();
    function pollForConnection(state){
        var attempts=0;
        function check(){
            if(attempts++>60) return;
            var script=document.createElement('script');
            var cb='asyntai_cb_'+Date.now();
            script.src='https://asyntai.com/connect-status.js?state='+encodeURIComponent(state)+'&cb='+cb;
            window[cb]=function(data){ try{ delete window[cb]; }catch(e){}
                if(data && data.site_id){ saveConnection(data); return; }
                setTimeout(check, 500);
            };
            script.onerror=function(){ setTimeout(check, 1000); };
            document.head.appendChild(script);
        }
        setTimeout(check, 800);
    }
    function saveConnection(data){
        showAlert('Asyntai connected. Savingâ€¦', true);
        var payload={ 
            site_id: data.site_id||'',
            [Craft.csrfTokenName]: Craft.csrfTokenValue
        };
        if(data.script_url) payload.script_url=data.script_url;
        if(data.account_email) payload.account_email=data.account_email;
        if (Craft && typeof Craft.sendActionRequest === 'function') {
            Craft.sendActionRequest('POST', 'asyntai/settings/save', { data: payload })
            .then(function(res){ var json=res && res.data || {}; if(!json.success) throw new Error(json.error||'Save failed');
                showAlert('Asyntai connected. Chatbot enabled on all pages.', true);
                var status=document.getElementById('asyntai-status');
                if(status){
                    var html='Status: <span style="color:#008a20;">Connected</span>';
                    if(payload.account_email){ html+=' as '+payload.account_email; }
                    html += ' <button id="asyntai-reset" class="btn">Reset</button>';
                    status.innerHTML=html;
                }
                var box=document.getElementById('asyntai-connected-box'); if(box) box.style.display='block';
                var wrap=document.getElementById('asyntai-popup-wrap'); if(wrap) wrap.style.display='none';
            })
            .catch(function(err){ showAlert('Could not save settings: '+(err && (err.message||err.response&&err.response.data&&err.response.data.error) || err), false); });
            return;
        }
        fetch(Craft.getActionUrl('asyntai/settings/save'), {
            method:'POST',
            headers:{ 
                'Content-Type':'application/json',
                'Accept':'application/json',
                'X-Requested-With':'XMLHttpRequest',
                'X-CSRF-Token':Craft.csrfTokenValue
            },
            credentials:'same-origin',
            body: JSON.stringify(payload)
        }).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(json){
            if(!json || !json.success) throw new Error(json && json.error || 'Save failed');
            showAlert('Asyntai connected. Chatbot enabled on all pages.', true);
            var status=document.getElementById('asyntai-status');
            if(status){
                var html='Status: <span style="color:#008a20;">Connected</span>';
                if(payload.account_email){ html+=' as '+payload.account_email; }
                html += ' <button id="asyntai-reset" class="btn">Reset</button>';
                status.innerHTML=html;
            }
            var box=document.getElementById('asyntai-connected-box'); if(box) box.style.display='block';
            var wrap=document.getElementById('asyntai-popup-wrap'); if(wrap) wrap.style.display='none';
        }).catch(function(err){ showAlert('Could not save settings: '+(err && err.message || err), false); });
    }
    function resetConnection(){
        var payload = { [Craft.csrfTokenName]: Craft.csrfTokenValue };
        if (Craft && typeof Craft.sendActionRequest === 'function') {
            Craft.sendActionRequest('POST', 'asyntai/settings/reset', { data: payload })
            .then(function(){ window.location.reload(); })
            .catch(function(err){ showAlert('Reset failed: '+(err && (err.message||err.response&&err.response.data&&err.response.data.error) || err), false); });
            return;
        }
        fetch(Craft.getActionUrl('asyntai/settings/reset'), { 
            method:'POST', 
            headers:{ 
                'Content-Type':'application/json',
                'Accept':'application/json',
                'X-Requested-With':'XMLHttpRequest',
                'X-CSRF-Token':Craft.csrfTokenValue 
            }, 
            credentials:'same-origin',
            body: JSON.stringify(payload)
        })
        .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(function(){ window.location.reload(); })
        .catch(function(err){ showAlert('Reset failed: '+(err && err.message || err), false); });
    }
    document.addEventListener('click', function(ev){ 
        var t=ev.target; 
        if(t && t.id==='asyntai-connect-btn'){ ev.preventDefault(); openPopup(); }
        if(t && t.id==='asyntai-reset'){ ev.preventDefault(); resetConnection(); }
        if(t && t.id==='asyntai-fallback-link'){ 
            // Re-generate state and update link when clicked
            currentState = generateState();
            updateFallbackLink();
            // Let the link work normally (target="_blank")
            // Also start polling for this state
            setTimeout(function(){ pollForConnection(currentState); }, 1000);
        }
    });
})();
</script>
{% endblock %}


